# CVE 2020-0601 AKA "Curveball"
A spoofing vulnerability exists in the way Windows CryptoAPI (Crypt32.dll) validates Elliptic Curve Cryptography (ECC) certificates.An attacker could exploit the vulnerability by using a spoofed code-signing certificate to sign a malicious executable, making it appear the file was from a trusted, legitimate source, aka 'Windows CryptoAPI Spoofing Vulnerability'.

## Reference
https://nvd.nist.gov/vuln/detail/CVE-2020-0601

## Analysis Notes
"Curveball" is an exploit that attempts to make a malicious executable or website certificate appear like it was signed by a trusted and legitiate source. In the event this is observed, analysts should begin looking back through the Application log to identify recently executed binaries or network logs to identify recently viewed websites on the affected host(s) and validate their signatures and behavior.

### Collection
While the signatures can be made to look like they're from valid souces, it is important to collect this information for analysis.

You can collect a Windows binary signature using Powershell.
```
Get-AuthenticodeSignature -FilePath "suspicious_file.extension"
```

You can collect a website SSL signature using openssl.
```
echo -n | openssl s_client -connect {HOSTNAME}:{PORT} -showcerts
```
*Note: `echo -n` gives a response to the server so that the connection is released and `-showcerts` downloads all the certificates in the chain.*


## KQL
ECS Data Source: [Winlogbeat](https://www.elastic.co/beats/winlogbeat)  
Query: `winlog.provider_name:"Microsoft-Windows-Audit-CVE"`

Data Source: [Zeek CVE-2020-0601 Plugin](https://github.com/0xxon/cve-2020-0601-plugin)  
Query: `zeek.notice.note:"CVE_2020-0601::Unknown_X509_Curve"`

## YARA
Unvalidated
```
rule CVE_2020_0601_pubkey_equal_custom_basepoint {
    strings:

        // ECC (ecPublicKey) OID 1.2.840.10045.2.1
        $ecPublicKey_OID = { 06 07 2a 86 48 ce 3d 02 01 }

        // 03 (type bit string), 62 (size), 00 04 (start of Pub key)
        $publicKey_ASN = { 03 62 00 04 }

        // 04 (type octet string), 61 (size), 04 (start of curve Base Point)
        $generator_ASN = { 04 61 04 }

    condition:
        //signed PE
        uint16(0) == 0x5a4d and
        pe.number_of_signatures > 0 and

        //Ensure cert using ECC
        $ecPublicKey_OID and

        //Ensure Pub Key and Base Point ASN elements appear after ECC OID
        for any x in (1..#publicKey_ASN) : (@publicKey_ASN[x] - @ecPublicKey_OID > 0 ) and
        for any x in (1..#generator_ASN) : (@generator_ASN[x] - @ecPublicKey_OID > 0 ) and

        //Use ASN Elements to locate Pub key & Base Point. Check if following 48 byte key/BP are equal
        for any x in (1..#publicKey_ASN) : (
                (@publicKey_ASN[x] - @ecPublicKey_OID > 0) and
                (@publicKey_ASN[x] - @generator_ASN > 0) and
                (@publicKey_ASN[x] - @generator_ASN < 500) and
                (for all i in (1..24) :
                    ( uint32be(@publicKey_ASN[x] + (i * 4)) == uint32be(@generator_ASN + ((i * 4) - 1))))
            )
}
```
Credit: @modubyk & @ollypwn

## SIGMA
```
title: Audit CVE Event
id: 48d91a3a-2363-43ba-a456-ca71ac3da5c2
status: experimental
description: Detects events generated by Windows to indicate the exploitation of a known vulnerability (e.g. CVE-2020-0601)
references:
    - https://twitter.com/mattifestation/status/1217179698008068096
    - https://twitter.com/VM_vivisector/status/1217190929330655232
    - https://twitter.com/davisrichardg/status/1217517547576348673
    - https://twitter.com/DidierStevens/status/1217533958096924676
    - https://twitter.com/FlemmingRiis/status/1217147415482060800
author: Florian Roth
date: 2020/01/15
logsource:
    product: windows
    service: application
detection:
    selection:
        Source: 'Microsoft-Windows-Audit-CVE'
    condition: selection
falsepositives:
    - Unknown
level: critical
```
Credit: Florian Roth (@cyb3rops)

## Modeling
Modeling is an important part of analysis, however it is not 1:1 "answer" to your analytical "question".

### MITRE ATT&CK
MITRE ATT&CK is a globally-accessible knowledge base of adversary tactics and techniques based on real-world observations. The ATT&CK knowledge base is used as a foundation for the development of specific threat models and methodologies in the private sector, in government, and in the cybersecurity product and service community.

#### Reference
https://attack.mitre.org/

```
Name: Code Signing
ID: T1116
Tactic: Defense Evasion
Platform: macOS, Windows
Data Sources: Binary file metadata
Defense Bypassed: Windows User Account Control
```
https://attack.mitre.org/techniques/T1116/

### Diamond Model
This is a model that lays out 4 (or in the extended model, 6) elements of an intrusion phase. Adversary, Infrastructure, Victim, and Capability. As you collect information from each "point", you can begin to make assumptions as to what the other points _could_ be. The more you have on each point, the more accurate your assumptions can be.

This model should be used in conjunction with other intrusion models, like the Lockheed Martin Cyber Kill Chain.

Do not use this model as an equation. Just because infrastructure is used in 2 intrusions, doesn't mean the victim or adversary are the same.

#### Reference
https://www.activeresponse.org/wp-content/uploads/2013/07/diamond.pdf

```
                      CVE-2020-0601
                      ┌───────────┐                 
                      │ Adversary │                 
                      └───────────┘                 
                            Λ                       
┌──────────────────────┐   ╱│╲                      
│      Capability      │  ╱ │ ╲                     
│    CVE 2020-0601     │ ╱  │  ╲  ┌────────────────┐
│ Code Signing (T1116) │▕───┼───▏ │ Infrastructure │
│   Defense Evasion    │ ╲  │  ╱  └────────────────┘
└──────────────────────┘  ╲ │ ╱                     
                           ╲│╱                      
                            V                       
                       ┌──────────┐                 
                       │  Victim  │                 
                       └──────────┘                 
```

### Lockheed Martin Cyber Kill Chain
Developed by Lockheed Martin, the Cyber Kill Chain® framework is part of the Intelligence Driven Defense® model for identification and prevention of cyber intrusions activity. The model identifies what the adversaries must complete in order to achieve their objective.

The seven steps of the Cyber Kill Chain® enhance visibility into an attack and enrich an analyst’s understanding of an adversary’s tactics, techniques and procedures.

1. Reconnaissance
1. Weaponization
1. Delivery
1. Exploitation <- CVE-2020-0601
1. Installation
1. Command & Control
1. Actions on the Objective

#### Reference
https://www.lockheedmartin.com/en-us/capabilities/cyber/cyber-kill-chain.html
